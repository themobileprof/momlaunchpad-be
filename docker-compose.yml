version: '3.8'

services:
  # Backend API
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: momlaunchpad-api
    restart: unless-stopped
    ports:
      - "${PORT:-8080}:8080"
    environment:
      # Database (connects to host PostgreSQL)
      DATABASE_URL: ${DATABASE_URL}
      
      # Redis (connects to host Redis on port 6379)
      REDIS_URL: ${REDIS_URL:-redis://host.docker.internal:6379}
      
      # DeepSeek API
      DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY}
      DEEPSEEK_BASE_URL: ${DEEPSEEK_BASE_URL:-https://api.deepseek.com/v1}
      DEEPSEEK_MODEL: ${DEEPSEEK_MODEL:-deepseek-chat}
      DEEPSEEK_MAX_TOKENS: ${DEEPSEEK_MAX_TOKENS:-1000}
      DEEPSEEK_TEMPERATURE: ${DEEPSEEK_TEMPERATURE:-0.7}
      DEEPSEEK_TIMEOUT: ${DEEPSEEK_TIMEOUT:-30s}
      
      # JWT
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRY: ${JWT_EXPIRY:-24h}
      
      # Server
      PORT: 8080
      ENV: ${ENV:-development}
      
      # Rate Limiting
      RATE_LIMIT_ENABLED: ${RATE_LIMIT_ENABLED:-true}
      RATE_LIMIT_REQUESTS_PER_MINUTE: ${RATE_LIMIT_REQUESTS_PER_MINUTE:-60}
      RATE_LIMIT_BURST: ${RATE_LIMIT_BURST:-10}
      
      # CORS
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-http://localhost:3000,https://*.momlaunchpad.com}
      
      # Memory
      SHORT_TERM_MEMORY_SIZE: ${SHORT_TERM_MEMORY_SIZE:-10}
      LONG_TERM_FACT_CONFIDENCE_THRESHOLD: ${LONG_TERM_FACT_CONFIDENCE_THRESHOLD:-0.7}
      
      # Calendar
      CALENDAR_SUGGESTION_ENABLED: ${CALENDAR_SUGGESTION_ENABLED:-true}
      
      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-info}
      LOG_FORMAT: ${LOG_FORMAT:-json}
      
      # Feature Flags
      FEATURE_SAVINGS: ${FEATURE_SAVINGS:-true}
      FEATURE_MULTILINGUAL: ${FEATURE_MULTILINGUAL:-true}
      
    extra_hosts:
      # Allow container to access host services (PostgreSQL, Redis)
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
